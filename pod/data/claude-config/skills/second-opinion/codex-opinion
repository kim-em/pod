#!/usr/bin/env bash
# Get a second opinion from OpenAI Codex
# Usage: codex-opinion "prompt" [working-dir]
#        echo "context" | codex-opinion "prompt" [working-dir]

set -euo pipefail

# Check if codex is available
if ! command -v codex &> /dev/null; then
    echo "Error: codex CLI not found. Install from https://github.com/openai/codex" >&2
    exit 1
fi

PROMPT="${1:-Provide your analysis of this context}"
WORKDIR="${2:-$(pwd)}"
CONTEXT=""

# Read context from stdin if available
if [ ! -t 0 ]; then
    CONTEXT=$(cat)
fi

# Find current Claude Code conversation log
# Project path is working dir with / replaced by -
PROJECT_PATH=$(echo "$WORKDIR" | sed 's|^/||; s|/|-|g')
PROJECT_DIR="$HOME/.claude/projects/-$PROJECT_PATH"
CONVERSATION_LOG=""
if [ -d "$PROJECT_DIR" ]; then
    # Get most recently modified .jsonl file (current session)
    CONVERSATION_LOG=$(ls -t "$PROJECT_DIR"/*.jsonl 2>/dev/null | head -1 || true)
fi

# Build the full prompt with context pointers
FULL_PROMPT="$PROMPT"

if [ -n "$CONTEXT" ]; then
    FULL_PROMPT="$FULL_PROMPT

Context provided:
$CONTEXT"
fi

if [ -n "$CONVERSATION_LOG" ]; then
    FULL_PROMPT="$FULL_PROMPT

If you need to review the full conversation I've been having with the user up to this request for a second opinion, it is available in: $CONVERSATION_LOG"
fi

# Run codex from working directory (allows exploring codebase)
# Use --full-auto to enable tool use
cd "$WORKDIR"
if git rev-parse --git-dir > /dev/null 2>&1; then
    codex exec --full-auto "$FULL_PROMPT"
else
    codex exec --full-auto --skip-git-repo-check "$FULL_PROMPT"
fi
